#!/bin/sh

set -eu

cpu_count=$(nproc)

# Load average from last minute
# http://linux.die.net/man/5/proc
load_avg=$(sed -rne 's/^([0-9\.]+) .*$/\1/p' /proc/loadavg)

domain=$(cat /etc/puavo/domain)

# TODO: https://github.com/opinsys/puavo-client/issues/7
organisation=$(sed -rne 's/^([^\.]+).*$/\1/p' /etc/puavo/domain)

# TODO: dns hackery
rest_server="http://127.0.0.1:9393"

url="$rest_server/v3/$organisation/ltsp_servers/$domain"

curl --config - \
     --request PUT \
     --max-time 5 \
    $url << EOF
data="cpu_count=$cpu_count"
data="load_avg=$load_avg"
user=$(cat /etc/puavo/ldap/dn):$(cat /etc/puavo/ldap/password)
EOF

